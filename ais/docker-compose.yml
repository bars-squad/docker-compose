version: "3.8"

services:
  zookeeper:
    image: 'bitnami/zookeeper:latest'
    networks:
      - ais_network
    ports:
      - '2181:2181'
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes

  kafka:
    image: 'bitnami/kafka:latest'
    networks:
      - ais_network
    volumes:
      - C:\docker-storage\kafka:/bitnami/kafka
    ports:
      - '9092:9092'
    depends_on:
      - zookeeper
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://127.0.0.1:9092
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes

  redis:
    container_name: redis
    image: redis
    command: redis-server /usr/local/etc/redis/redis.conf
    ports:
      - 6379:6379
    networks:
      - ais_network
    volumes:
      - ./redis.conf:/usr/local/etc/redis/redis.conf

  mongo:
    container_name: mongo
    image: mongo:5.0.0-rc1-focal
    command: mongod --replSet mongo-replica-set
    ports:
      - 37017:27017
    networks:
      - ais_network
    volumes:
      - C:\docker-storage\mongodb\data:/data/db

  mongo1:
    container_name: mongo1
    image: mongo:5.0.0-rc1-focal
    ports:
      - 37018:27017
    command: mongod --replSet mongo-replica-set
    networks:
      - ais_network
    depends_on:
      - mongo

  mongo2:
    container_name: mongo2
    image: mongo:5.0.0-rc1-focal
    ports:
      - 37019:27017
    command: mongod --replSet mongo-replica-set
    networks:
      - ais_network
    depends_on:
      - mongo

  administrator_api:
    container_name: administrator_api
    image: difaal21/administrator_api
    build: .
    ports:
      - 5000:5000
    depends_on:
      - redis
    networks:
      - ais_network
    environment:
      - HOST_USER_COMMAND=http://user_command:5002
      - PORT=5000
      - BASIC_AUTH_USERNAME=root
      - BASIC_AUTH_PASSWORD=root
      - BASIC_AUTH_USERNAME_PERSISTENCE=root-persistence
      - BASIC_AUTH_PASSWORD_PERSISTENCE=root-persistence
      - PUBLIC_KEY_PATH=public.pem
      - PRIVATE_KEY_PATH=private.pem
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
    command: npm start
    stdin_open: true
    tty: true

  user_command:
    container_name: user_command
    image: difaal21/user_command
    build: .
    ports:
      - 5002:5002
    depends_on:
      - redis
      - administrator_api
      - mongo
    networks:
      - ais_network
    environment:
      - APP_NAME=go-template
      - PORT=5002
      - BASIC_AUTH_USERNAME=root-persistence
      - BASIC_AUTH_PASSWORD=root-persistence
      - MONGODB_URL=mongodb://mongo:27017/ais-user
      - MONGODB_DATABASE=ais-user
      - MONGODB_MIN_POOL_SIZE=50
      - MONGODB_MAX_POOL_SIZE=100
      - MONGODB_MAX_IDLE_CONNECTION_TIME_MS=10000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DATABASE=
      - REDIS_USERNAME=
      - REDIS_PASSWORD=
      - REDIS_SSL_ENABLE=
    command: go run main.go
    stdin_open: true
    tty: true

networks:
  ais_network:
    name: ais_network
    driver: bridge

volumes:
  data:
    external: true
